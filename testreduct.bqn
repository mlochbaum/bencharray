#! /usr/bin/env bqn

# Format number with 3 sig figs and scientific notation
Fmt â‡ {
  e â† âŒŠâ€¢math.Log10ğ•©
  r â† 0.5+ğ•©Ã—10â‹†2-e
  {râ‰¥1e3? rÃ·â†©10 â‹„ e+â†©1 ; @}
  (1(â†‘âˆ¾"."âˆ¾â†“)â€¢ReprâŒŠr)âˆ¾"e"âˆ¾â€¢Repr e
}

Spl â† (âŠ¢-ËœÂ¬Ã—+`)âŠ¸âŠ”          # Split by boolean left argument
Trim â† ((âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)' 'âŠ¸â‰ )âŠ¸/  # Trim leading and trailing spaces

# Alert if the first function is at least 20% slower than the second
CompareTime â† { fnsc ğ•Š arg:
  fnsâ€¿chk â† 2(â†‘â‹ˆâ†“)â€¢BQNÂ¨fnsc
  Bad â† â‰¥âŸœ(1.2âŠ¸Ã—)Â´
  GetApply â† {mğ•ŠâŸ¨w,xâŸ©: {ğ•¨ wâŠ¸ğ•_m x}; mğ•ŠâŸ¨xâŸ©: {ğ•¨ ğ•_m x}}âŸœarg
  On â† (GetApply {{ğ”½}})Â¨
  Time â† (GetApply â€¢timed)Â¨âŸœfns
  âˆ§Â´ On chk ?
  "Non-matching result!" ! â‰¡Â´ On fns
  Bad tâ†Time 1 ? Bad ttâ†Time 3âŒˆâŒˆ0.03Ã·t ?
  # Failed!
  Vs â† âˆ¾âŸœ" vs "âŠ¸âˆ¾
  â€¢Out ((Vsâ—‹TrimÂ´2â†‘fnsc)âˆ¾" on "âˆ¾arg.desc) âˆ¾ ": " âˆ¾ Vsâ—‹FmtÂ´ t
  ; @
}

RunGroup â† {
  argsâ€¿equivs â† 2â†‘('%'â‰ âŠ‘Â¨)âŠ¸âŠ” ğ•©
  ('%'âŠ¸=âŠ¸SplÂ¨ equivs) CompareTimeâŒœ âˆ¾ (â¥Šâˆ˜â€¢BQN 1âŠ¸â†“)Â¨ args
}

filesâ€¿opts â† 2 â†‘ ('-'=âŠ‘)Â¨âŠ¸âŠ” â€¢args
files â†© (0<â‰ )â—¶âŸ¨1,âˆ¨Â´"all"âŠ¸â‰¡Â¨âŸ©â—¶âŸ¨âˆ¾âŸœ".bqn"Â¨, â€¢file.Listâˆ˜"reductions"âŸ© files

lines â† âˆ¾ (âŸ¨""âŸ© âˆ¾Ëœ Â· (0<â‰ )â—¶1â€¿('#'â‰ âŠ‘)Â¨âŠ¸/ Â· â€¢file.Lines "reductions/"âŠ¸âˆ¾)Â¨ files
groups â† (0=â‰ Â¨)âŠ¸Spl lines
â€¢Out 1â†“âˆ¾' 'âŠ¸âˆ¾Â¨ âŸ¨"Running",â€¢Reprâ‰ groups,"groups:"âŸ©âˆ¾Â¯4â†“Â¨files
RunGroupÂ¨ groups
