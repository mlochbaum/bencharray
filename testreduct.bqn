#! /usr/bin/env bqn

Spl â† (âŠ¢-ËœÂ¬Ã—+`)âŠ¸âŠ”          # Split by boolean left argument
Trim â† ((âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)' 'âŠ¸â‰ )âŠ¸/  # Trim leading and trailing spaces

opts â† {
help_pre â† 1â†“"
Strength reduction tester: compare runtime of equivalent expressions.
Argument is a list of input files and options. Options:"

  shortâ€¿longâ€¿argsâ€¿dupâ€¿desc â† <Ë˜â‰> âŸ¨
    "h"â€¿"help"     â€¿0â€¿1â€¿"Print this message and exit"
    "t"â€¿"threshold"â€¿1â€¿0â€¿"Minimum relative performance difference for output (1.2)"
  âŸ©
  shortâ€¿long âˆ¾ËœÂ¨âŸœ<Â¨â†© "-"â€¿"--"
  args âˆ¾â†© 0

  c â† â‰ short
  op â† (shortâŠ¸âŠ âŒŠ longâŠ¸âŠ) â€¢args
  op âŒˆâ†© c Ã—Â¬ <`âŠ¸= opâŠargs
  opts â† ((1+c)âˆ¾Ëœf/op) âŠ” ((op=c)(1-ËœÃ—âŸœ(+`))â—‹(âˆ¾âŸœ1)fâ†Â¬0Â»opâŠargs) âŠ” â€¢args
  "Option can't be duplicated" ! âˆ§Â´ (dupâˆ¾1) â‰¥ 1<â‰ Â¨opts
  os â† (0âŒ¾âŠ‘dupâˆ¾0) (âˆ¾','âŠ¸SplÂ¨)âŸâŠ£Â¨ (1âŒ¾(Â¯1âŠ¸âŠ‘)args) âŠ£â—¶âŸ¨0<â‰ âˆ˜âŠ¢,âŠ‘Â¨âŠ¢âŸ©Â¨ opts
  helpâ€¿thresholdâ€¿files â‡ os
  threshold â†© 1.2 âŠ£Â´ â€¢ParseFloatÂ¨ threshold

  { help ?
    opt_help â† âˆ¾Â¨Â´ âŸ¨descâŸ© âˆ¾Ëœ (1+Â·âŒˆÂ´â‰ Â¨)âŠ¸(â†‘Â¨)Â¨ shortâ€¿long âˆ¾Â¨Â¨ ",:"
    â€¢Out âˆ¾âˆ¾âŸœ(@+10)Â¨ âŸ¨help_pre,""âŸ© âˆ¾ opt_help
    â€¢Exit@
  ;@}
}

files â† (0<â‰ )â—¶âŸ¨1,âˆ¨Â´"all"âŠ¸â‰¡Â¨âŸ©â—¶âŸ¨âˆ¾âŸœ".bqn"Â¨, â€¢file.Listâˆ˜"reductions"âŸ© opts.files

# Format number with 3 sig figs and scientific notation
Fmt â‡ {
  e â† âŒŠâ€¢math.Log10ğ•©
  r â† 0.5+ğ•©Ã—10â‹†2-e
  {râ‰¥1e3? rÃ·â†©10 â‹„ e+â†©1 ; @}
  (1(â†‘âˆ¾"."âˆ¾â†“)â€¢ReprâŒŠr)âˆ¾"e"âˆ¾â€¢Repr e
}

# Alert if the first function is at least 20% slower than the second
CompareTime â† { fnsc ğ•Š arg:
  fnsâ€¿chk â† 2(â†‘â‹ˆâ†“)â€¢BQNÂ¨fnsc
  Bad â† â‰¥âŸœ(opts.thresholdâŠ¸Ã—)Â´
  GetApply â† {mğ•ŠâŸ¨w,xâŸ©: {ğ•¨ wâŠ¸ğ•_m x}; mğ•ŠâŸ¨xâŸ©: {ğ•¨ ğ•_m x}}âŸœarg
  On â† (GetApply {{ğ”½}})Â¨
  Time â† (GetApply â€¢timed)Â¨âŸœfns
  âˆ§Â´ On chk ?
  "Non-matching result!" ! â‰¡Â´ On fns
  Bad tâ†Time 1 ? Bad ttâ†Time 3âŒˆâŒˆ0.03Ã·t ?
  # Failed!
  Vs â† âˆ¾âŸœ" vs "âŠ¸âˆ¾
  â€¢Out ((Vsâ—‹TrimÂ´2â†‘fnsc)âˆ¾" on "âˆ¾arg.desc) âˆ¾ ": " âˆ¾ Vsâ—‹FmtÂ´ t
  ; @
}

# Generate argument from one of several abstract specifiers
MakeArg â† {
  âŸ¨Post,argâŸ©: Post ğ•Š arg
;
  âŸ¨warg,xargâŸ©:
    wâ€¿xâ‡ â‹„ âŸ¨wdâ‡desc,wâ‡xâŸ©â€¿âŸ¨xdâ‡desc,xâŸ© â† ğ•ŠÂ¨ wargâ€¿xarg
    GetDesc â† {câ†+Â´âˆ§`=Â´(ğ•¨âŒŠâ—‹â‰ ğ•©)â†‘Â¨ğ•¨â€¿ğ•©â‹„(câ†‘ğ•¨)âˆ¾âˆ¾âŸœ" and "âŠ¸âˆ¾Â´câ†“Â¨ğ•¨â€¿ğ•©}
    desc â‡ {âŸ¨râ‡descâŸ©:r ; wd GetDesc xd} ğ•©
;
  âŸ¨len,typeâŸ©:
    r â† 2â€¿100â€¿1e4â€¿1e9â€¿0âŠ‘Ëœ"bool"â€¿"i8"â€¿"i16"â€¿"i32"â€¿"f64"âŠ¸âŠâŒ¾<type
    x â‡ len â€¢rand.Range r
    desc â‡ âˆ¾âŸ¨â€¢Repr len," ",typeâŸ©
;
  âŸ¨len,rangeâŸ©:
    descâ‡âˆ¾âŸ¨â€¢Repr len," <",â€¢Repr rangeâŸ©
    xâ‡len â€¢rand.Range range
;
  ğ•©
}

RunGroup â† {
  argsâ€¿equivs â† 2â†‘('%'â‰ âŠ‘Â¨)âŠ¸âŠ” ğ•©
  (('%'âŠ¸=âŠ¸SplÂ¨ equivs) CompareTimeÂ¨ <âˆ˜MakeArg)Â¨ âˆ¾ (â¥Šâˆ˜â€¢BQN 1âŠ¸â†“)Â¨ args
}

lines â† âˆ¾ (âŸ¨""âŸ© âˆ¾Ëœ Â· (0<â‰ )â—¶1â€¿('#'â‰ âŠ‘)Â¨âŠ¸/ Â· â€¢file.Lines "reductions/"âŠ¸âˆ¾)Â¨ files
groups â† (0=â‰ Â¨)âŠ¸Spl lines
â€¢Out 1â†“âˆ¾' 'âŠ¸âˆ¾Â¨ âŸ¨"Running",â€¢Reprâ‰ groups,"groups:"âŸ©âˆ¾Â¯4â†“Â¨files
RunGroupÂ¨ groups
