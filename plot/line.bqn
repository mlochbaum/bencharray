Numâ€¿Posâ€¿SVGâ€¿Geâ€¿Eltâ€¿Atâ€¿Encâ€¿Rectâ€¿Textâ€¿TSizeâ€¿Path â† â€¢Import "svg.bqn"

# Graph components
Background â† <"fill=white" Rect âŠ¢
Clip â† <"defs" Enc ("clipPath"At"id=clip") Enc Rect

Box â† "stroke-width=1.2|stroke=#111|fill="âŠ¸âˆ¾ âŠ¸ Rect
Outline â† <"none" Box âŠ¢

Legend â† {
  outerâ€¿placeâ€¿spacingâ€¿padâ€¿widthâ€¿labelâ€¿Samples â† ğ•©
  y â† pad+spacingÃ—0.5+â†•nâ†â‰ label
  dim â† âŸ¨width,(2Ã—pad)+spacingÃ—nâŸ©
  pl â† (10â€¿6Ã—Â¬âŠ¸-place) + placeÃ—outer-dim
  ltr â† "transform=translate("âˆ¾")"âˆ¾Ëœâˆ¾âŸœ","âŠ¸âˆ¾Â´Num pl
  legend â† (ltrâˆ¾"|text-anchor=start|font-size=13px") Ge âŸ¨
    "white" Box 0â€¿0â‰dim
    Samples y
    y (Pos 36âŠ¸â‹ˆ)âŠ¸TextÂ¨ label
  âŸ©
}

Tick â† {
  offâ€¿dimâ€¿orientâ€¿tposâ€¿ttext â† ğ•©
  s â† 'h'=orient
  Lines â† {
    h â† 'h'=ğ•¨
    P â† âŒ½âŒ¾(2âŠ¸â†‘)âŸh âˆ¾âŸœ((Â¬h)âŠâ‰offâ‰dim)
    ("path"Elt"d"â‹ˆÂ·âˆ¾("M "âˆ¾ğ•¨)âˆ¾Â¨Numâˆ˜P)Â¨ ğ•©
  }
  dist â† (sâŠdim)(-âŒŠâŠ¢)tpos-sâŠoff
  Filter â† â‰¤âŸœdist/Â¨âŠ¢
  to â† 9.5â€¿Â¯6 + âŒ½off+dimÃ—0â€¿1
  Vals â† { "text-anchor=end" GeâŸğ•¨ (Pos ğ•¨âŒ½â‹ˆâŸœ(ğ•¨âŠ‘to))âŠ¸TextÂ¨Â´ ğ•© }
  âŸ¨
    "stroke-width=0.3|stroke=#555" Ge orient LinesÂ¨ 1 Filter tpos
    "font-size=11px" Ge s ValsÂ¨ tpos â‹ˆÂ¨â—‹(Â¯0.01âŠ¸Filter) ttext
  âŸ©
}

_inRange â† {âŒˆâŠ¸(âŠ£+â†•âˆ˜Â¬Ëœ)âŸœâŒŠâŒ¾(ğ”½â¼)Â´}
GetTicks â† {
  ğ•Šğ•©: 0ğ•Šğ•©;
  0ğ•Šğ•©: # Linear
    dist â† {(âŠ‘âˆ˜â‹âŸœğ•©-1Ë™)âŠ¸âŠ‘ 1â€¿2â€¿5 Ã— âŒŠâŒ¾(10â‹†â¼âŠ¢) ğ•©} 6 Ã·Ëœ -ËœÂ´ ğ•©
    distâŠ¸Ã—_inRange ğ•©;
  1ğ•Šğ•©: # Log
    p â† âŸ¨â‹ˆ1, 1â€¿2â€¿5, âˆ§1.5â€¿7âˆ¾1+â†•5, âˆ§1.2â€¿1.5â€¿2.5âˆ¾1+â†•9âŸ©
    i â† 0âŒˆ1-Ëœ âŠ‘ (â‰ Â¨p) â‹ 12 Ã· -ËœÂ´ 10â‹†â¼ğ•©
    (1â‰¥-ËœÂ´âˆ˜â‹)â—¶âŠ£â€¿âŠ¢âŸœğ•© (iâŠ‘p) (â¥ŠÃ—âŒœËœ) (10â‹†âŠ¢)_inRange ğ•©Ã·10â€¿1
}

# Name info
GetColors â† {
  nam â† â‹ˆ"BQN"
  col â† â‹ˆ"#2b7067"
  ce  â† âŸ¨"#e41a1c","#377eb8","#4daf4a","#984ea3"
         "#ff7f00","#ffff33","#a65628","#f781bf"âŸ©
  ni â† nam âŠ ğ•©
  ni +â†© (â‰ ce)|âŠ’âŠ¸Ã—ni=â‰ nam  # Cycle through extra colors
  ni âŠ colâˆ¾ce
}

ENum â† {âˆ¾âŸœ"e"âŠ¸âˆ¾â—‹NumÂ´ (ğ•©Ã·10âŠ¸â‹†)âŠ¸((1<5eÂ¯4+Ã·âŸœ10)â—¶âŸ¨â‹ˆ,Ã·âŸœ10âŠ¸â‹ˆâŸœ(1âŠ¸+)âŸ©)âŒŠ10â‹†â¼ğ•©}
DispNum â† (2|1eÂ¯9â€¿1eÂ¯3â€¿1e4âŠ¸â‹âŒ¾<)â—¶Numâ€¿ENum

Plot â‡ { opts ğ•Š dat:
  titleâ€¿xâ€¿yâ€¿labels â† opts
  order â† {âŸ¨râ‡orderâŸ©:r; âŠ¢} opts
  changeBounds â† {âŸ¨râ‡changeBoundsâŸ©:r; âŠ¢} opts
  col â† "stroke"âŠ¸â‹ˆÂ¨ GetColors labels

  axes â† xâ€¿y
  xcaptâ€¿ycapt â† {ğ•©.name}Â¨ axes
  alog â† {âŸ¨râ‡logâŸ©:r; 1}Â¨ axes
  disp â† {âŸ¨râ‡dispâŸ©:r; DispNum}Â¨ axes

  width â† 512
  off â† 60â€¿40 â‹„ end â† 20â€¿50
  dim â† width (âŠ£â‹ˆÃ—) 0.55
  out â† (-off)â‰dim+off+end
  padb â† alog Ã— padi â† 0â€¿20

  gr â† "stroke-width=2.6|font-size=14px|text-anchor=middle"
  ls â† "clip-path=url(#clip)|fill=none|stroke-linecap=round|stroke-linejoin=round"

  Log â† ({âŸ¨Râ‡TransâŸ©:R; âŠ¢}âŠ‘axes)âŒ¾âŠ‘ â‹†â¼âŒ¾(alogâŠ¸/)
  dat â†© 0â€¿0 â†“ Order dat
  xy â† <âˆ˜âˆ¾Ë˜â‰dat
  win â† -Ëœ`Â¨ 0âŒ¾(âŠ‘1âŠ‘âŠ¢)âŸ(Â¬1âŠ‘alog) Log bounds â† ChangeBounds (âŒŠÂ´â‰âŒˆÂ´)âˆ˜â¥ŠÂ¨ xy
  ScaleI â† Â¬âŒ¾(1âŠ¸âŠ‘) ({ğ•©Ã·Ëœğ•¨-ËœâŠ¢}Ë â‰>win)âˆ˜Log          # To [0,1]
  Scale â† padi + (dim-padb+padi) Ã— ScaleI          # To pixels
  line â† (<â‰Ë˜)â—‹NumÂ´âˆ˜ScaleË˜ dat

  âˆ¾ âˆ¾âŸœ(@+10)Â¨ (â¥Šout) SVG gr Ge âŸ¨
    Clip 0â€¿0â‰dim
    Background out
    âŸ¨
      ((TSize 18)âˆ¾PosâŸ¨widthÃ·2,Â¯19âŸ©) Text title
      xcapt TextËœ Pos 0â€¿32+dimÃ—0.5â€¿1
      ycapt TextËœ "transform"â€¿"rotate(-90)"âˆ¾Pos 0â€¿42-ËœâŒ½dimÃ—0â€¿Â¯0.5
    âŸ©
    Tick {
      offâ‡0â€¿0 â‹„ dimâ‡dim
      orientâ‡"vh"
      RoundDown â† {(âŠ‘âˆ˜â‹âŸœğ•©-1Ë™)âŠ¸âŠ‘1â€¿2â€¿5Ã—âŒŠâŒ¾(10â‹†â¼âŠ¢)ğ•©}
      tpos â‡ Scale ticks â† (â·âˆ§âŠ‘xy) {ğ•¨âŒ¾âŠ‘ğ•©}âŸ(10â‰¥â‰ âˆ˜âŠ£) alog GetTicksâŸœâˆ§Â¨ Scaleâ¼0â‹ˆÂ¨dim
      ttext â‡ disp {ğ•âš‡0ğ•©}Â¨ ticks
    }
    ls Ge col â‰âŠ¸PathâŸœ('M'âŒ¾âŠ‘âˆ˜âˆ¾Â·â¥Š "L "âˆ¾Â¨â‰1âŠ¢)Â¨ line
    Outline 0â€¿0â‰dim
    Legend {
      label â‡ Order labels
      outer â‡ dim
      place â‡ (â†•2â€¿2) âŠ‘âˆ˜â’âŠ¸âŠ‘Ëœâ—‹â¥Š âŒŠÂ´Â¨ â‰Ë˜âŸœÂ¬ â‰¤âŸœ(Ã·4)âŠ¸/{ğ”½â‹ˆÂ¬âŠ¸ğ”½}Â´ ScaleI xy
      width â‡ 134 â‹„ spacing â‡ 18 â‹„ pad â‡ 6
      Samples â‡ col â‰âŠ¸PathâŸœ(âˆ¾"M h"âˆ¾Â¨Num)Â¨ (8âˆ¾âˆ¾âŸœ22)Â¨
    }
  âŸ©
}
