# Write files and run the measurement function
lang â† â€¢Importâˆ˜"langs.bqn"âŠ¸(âŠ‘âŠ£âŠËœ{ğ•©.name}Â¨âŠ¸âŠâŸœ<)âŸ(6â‰ â€¢Type) âŠ‘â€¢args

# Adapted from _timedGen in measure/time.bqn
a0 â† 4                            # Number of wanted argument sets
_estCount â† {
  t â† ğ•¨ ğ”½â—‹{ğ•@} ğ•©                  # Start with one timing
  n â† 1+âŒŠ(1+1eÂ¯1Ã·t)Ã·2             # Target 0.1 for one run, 0.05 for many
  n<50 ?
    nâ€¿(n âŒŠ a0 âŒˆ âŒŠ5Ã·n)
  ;
    t â† (+Â´Ã·â‰ )ğ•¨ğ”½Â¨â—‹{ğ•Â¨â†•10}ğ•©        # Redo the timing with more runs
    a â† a0 + âŒŠ2eÂ¯5Ã·t              # Try to add sets
    r â† âŒˆ(200âŒŠ2eÂ¯2Ã·t)Ã·a           # Number of reps
    râ€¿a
}

typ â† {
  Get â† â€¢internal.Eltype
  fmt â† âˆ¾âŸœâ€¢FmtÂ´Â¨ bit â† "uiiif" â‹ˆÂ¨ 2â‹†0âˆ¾3+â†•4
  Write â‡ fmtâŠ‘ËœGet
  Conv â‡ {wâ†âŒ½bitâŠ‘ËœGetğ•© â‹„ âŸ¨w,8â€¿'c'âŸ© â€¢bit._cast âˆ¾âŸœ(0â¥ŠËœ8|-âˆ˜â‰ )âŸ(1=âŠ‘w) ğ•©}
}

TimeFn â‡ {
  iterâ€¿num â† {
    fnâ€¿x  :   fn    â€¢_timed   _estCount x ;
    fnâ€¿wâ€¿x: w fn{ğ•¨âŠ¸ğ”½â€¢_timedğ•©} _estCount x
  } ğ•©
  arrs â† â¥Šâ‰> {ğ•Â¨â†•num}Â¨ 1â†“ğ•©
  valence â† 1-Ëœâ‰ ğ•©
  header â† (typ.Writeâˆ¾Â·âˆ¾' 'âˆ¾Â¨â€¢FmtÂ¨âˆ˜â‰¢)Â¨ arrs
  meta â† âŸ¨valence lang.FmtFn âŠ‘ğ•©âŸ©âˆ¾(â€¢FmtÂ¨valenceâ€¿iter)âˆ¾header
  "/tmp/bencharray_meta" â€¢file.Lines meta
  "/tmp/bencharray_data" â€¢file.Bytes âˆ¾ typ.Convâˆ˜â¥ŠÂ¨ arrs
  Run â† {ğ•Š:
    res â† â€¢SH lang.shell âˆ¾< â€¢file.At"avgtime."âˆ¾lang.extension
    (2âŠ¸âŠ‘ ! 0=âŠ‘) res
    â€¢BQN "_Â¯" (âŠ¢+-ËœÂ´âˆ˜âŠ£Ã—âŠ‘âŠ¸=) 1 âŠ‘ res
  }
  num Ã·Ëœ Runâ€¢_while_(1eÂ¯9âŠ¸>) 0
}
