# Write files and run the measurement function

# Adapted from _timedGen in measure/time.bqn
a0 â† 4                            # Number of wanted argument sets
_estCount â† {
  t â† ğ•¨ ğ”½â—‹{ğ•@} ğ•©                  # Start with one timing
  n â† 1+âŒŠ(1+1eÂ¯1Ã·t)Ã·2             # Target 0.1 for one run, 0.05 for many
  n<50 ?
    nâ€¿(n âŒŠ a0 âŒˆ âŒŠ5Ã·n)
  ;
    t â† (+Â´Ã·â‰ )ğ•¨ğ”½Â¨â—‹{ğ•Â¨â†•10}ğ•©        # Redo the timing with more runs
    a â† a0 + âŒŠ2eÂ¯5Ã·t              # Try to add sets
    r â† âŒˆ(200âŒŠ2eÂ¯2Ã·t)Ã·a           # Number of reps
    râ€¿a
}

typ â† {
  Get â† â€¢internal.Eltype
  fmt â† âˆ¾âŸœâ€¢FmtÂ´Â¨ bit â† "uiiif" â‹ˆÂ¨ 2â‹†0âˆ¾3+â†•4
  Write â‡ fmtâŠ‘ËœGet
  Conv â‡ {wâ†âŒ½bitâŠ‘ËœGetğ•© â‹„ âŸ¨w,8â€¿'c'âŸ© â€¢bit._cast âˆ¾âŸœ(0â¥ŠËœ8|-âˆ˜â‰ )âŸ(1=âŠ‘w) ğ•©}
}

TimeFn â‡ {
  iterâ€¿num â† {
    fnâ€¿x  :   fn    â€¢_timed   _estCount x ;
    fnâ€¿wâ€¿x: w fn{ğ•¨âŠ¸ğ”½â€¢_timedğ•©} _estCount x
  } ğ•©
  arrs â† â¥Šâ‰> {ğ•Â¨â†•num}Â¨ 1â†“ğ•©
  header â† (typ.Writeâˆ¾Â·âˆ¾' 'âˆ¾Â¨â€¢FmtÂ¨âˆ˜â‰¢)Â¨ arrs
  meta â† âŸ¨"I."âŸ©âˆ¾(â€¢FmtÂ¨âŸ¨1-Ëœâ‰ ğ•©,iterâŸ©)âˆ¾header  # Hard-coded / â†’ I.
  "/tmp/bencharray_meta" â€¢file.Lines meta
  "/tmp/bencharray_data" â€¢file.Bytes âˆ¾ typ.Convâˆ˜â¥ŠÂ¨ arrs
  res â† 1 âŠ‘ â€¢SH "j9"â€¿"-c"â€¿(â€¢file.At"avgtime.ijs")
  num Ã·Ëœ 0 âŒˆ â€¢BQN "_Â¯" (âŠ¢+-ËœÂ´âˆ˜âŠ£Ã—âŠ‘âŠ¸=) res
}
