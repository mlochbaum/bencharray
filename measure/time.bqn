# Utilities for estimated timings

_bind â† {ğ”½ğ•;ğ•ğ”½ğ•}

# Estimated average time to run ğ”½ in ğ•¨ ğ”½Â¨ ğ•© when ğ”½ is quick
# Time for ğ”½ is assumed deterministic but can vary based on argument
# Calls ğ”½ at least 200 times, and at least 9 on each argument
# For best reliability, an individual call of ğ”½ should take >5Î¼s
# Seems accurate within 2% or so
_avgTime_ â‡ {
  n â† â‰ â¥Šğ•¨âŠ¢Â¨ğ•©                      # Number of calls (ğ•˜ reps each)
  Mid â† (âŒˆğ•˜Ã·2)â†‘(âŒŠÂ´0â€¿2+âŒŠğ•˜Ã·3â€¿10)â†“âˆ§  # Reject potential outliers
  FT â† (+Â´Ã·â‰ )âˆ˜â¥Š Â·MidË˜âˆ˜â‰ ğ”½Â¨        # And average
  t â† ğ•¨ FT _bindâ—‹({ğ•©Ë™}ğ•˜â€¿nâŠ¸â¥Š) ğ•©    # Bind argument arrays
  Cond â† {
    4>â‰ ğ•©?1;                       # Always take at least 5 samples
    20â‰¤â‰ ğ•©?0;                      # And give up at 20
    Â¬âˆ§Â´(âŠ¢â‰¤1.01Ã—âŒŠÂ´)Â¯3â†‘ğ•©            # Stop if samples are within 1%
  }
  âŒŠÂ´ âˆ¾âŸœT â€¢_while_ Cond â†•0         # Run to completion; take minimum
}

# Estimated time to run function given argument generators
# Tries to limit total time used, so if one run takes a while and can
# differ based on generator output then the result will be inconsistent
# Quick calls are pooled to reject outliers; for slower ones this is
# less likely to work so we just average
TimeFn â‡ {
  _sub â† { # Function and arguments are ğ•¨ğ”½ğ•© here
    t â† 5eÂ¯9âŒˆğ•¨ ğ”½â—‹{ğ•@} ğ•©           # Start with one timing (also warmup)
    a â† 4                         # Number of wanted argument sets
    n â† 1+âŒŠ(1+1eÂ¯1Ã·t)Ã·2           # Target 0.1 for one run, 0.05 for many
    ğ•¨ğ”½{
      n<50 ?
        a âŒŠâ†© n                    # Don't make args that won't be used
        t â† ğ•¨ğ”½Â¨â—‹{nâ¥Šğ•Â¨â†•a}ğ•©         # Repeat args to get rep number up
        (+Â´Ã·â‰ ) âŒŠÂ´Â¨ (a|â†•âˆ˜â‰ )âŠ¸âŠ” t    # Min across equal args, then average
      ;
        a +â†© âŒŠ2eÂ¯5Ã·t              # Try to add sets
        r â† âŒˆ(200âŒŠn)Ã·a            # Number of reps
        ğ•¨ ğ”½_avgTime_ râ—‹{ğ•Â¨â†•a} ğ•©   # Do the fancy timing
    }ğ•©
  }
  {fnâ€¿x: fnâ€¢_timed _sub x; fnâ€¿wâ€¿x: w fn{ğ•¨âŠ¸ğ”½â€¢_timedğ•©} _sub x} ğ•©
}
