# Monadic /

âŸ¨RandBoolâŸ© â† â€¢Import "../measure/gen.bqn"
scale â† â€¢Import"../measure/scale.bqn"

GetSizes â† { ğ•Š exp:
  name â‡ "Size"
  range â‡ 10â‹†exp
  labels â‡ ("length 1e"âˆ¾â€¢Repr)Â¨ exp
}

sizes â† GetSizes 2â€¿4â€¿6

maxes â† {
  name â‡ "Max"
  range â‡ 10â‹†expâ†1â€¿2â€¿3â€¿4â€¿5
  labels â‡ ("max 1e"âˆ¾â€¢Repr)Â¨ exp
  Order â‡ âŒ½
}

Bench â† {
  paramsâ€¿inputâ€¿measure â‡ extâ€¿plotname â† opts â† ğ•©
  name â‡ "indices-"âˆ¾ext

  result â‡ ({âŸ¨râ‡outputâŸ©:âŸ¨râŸ©;âŸ¨âŸ©}ğ•©) â€¢Import "../params/ns_v.bqn"

  plotOpts â‡ {
    title â‡ plotname
    x â‡ input
    y â‡ result
    key â‡ {labelsâ‡â‹ˆ"/"} âŠ£Â´ params
  }
}

Inverse â† { ğ•Š eâ€¿descâ€¿GetGen:
  ext â‡ "inverse-"âˆ¾e
  plotname â‡ desc
  params â‡ âŸ¨maxesâŸ©
  input â‡ {
    name â‡ "Input length"
    max â‡ 1e7
    range â‡ scale.Q13 max
  }
  output â‡ {max â‡ 100, denom â‡ "input"}

  Measure â‡ { ğ•Š âŸ¨maxâŸ©:
    gen â† GetGen âŸ¨maxâŸ© â€¢Import "../measure/gen.bqn"
    TimeParams â‡ { âŸ¨/â¼, ğ•© Gen maxË™âŸ© }
    timeInit â‡ 1e5â€¿1â€¿1e3
  }
}

BenchÂ¨ âŸ¨
  {
    ext â‡ "where-length"
    plotname â‡ "Indices from uniform boolean list"
    params â‡ âŸ¨âŸ©

    input â‡ {
      name â‡ "Input length"
      max â‡ 1e7
      range â‡ scale.E13 max
    }
    output â‡ {denom â‡ "input"}

    measure â‡ {
      TimeParams â‡ { âŸ¨/, RandBoolâˆ˜ğ•©âŸ© }
      timeInit â‡ 1e5â€¿1â€¿1e3
    }
  }
  {
    ext â‡ "where-density"
    plotname â‡ "Indices from boolean lists"

    params â‡ âŸ¨sizesâŸ©
    input â‡ {
      name â‡ "Density (+Â´Ã·â‰ )"
      max â‡ 1
      log â‡ 0 â‹„ Trans â‡ 1.6âŠ¸âˆšâŒ¾(1-ËœÃ·)
      range â‡ Ã—ËœâŒ¾(1-ËœÃ·) â†•âŠ¸âˆ¾âŠ¸Ã· 20
      FilterMin â‡ Â¬âˆŠâŸœ0â€¿1
    }
    output â‡ {denom â‡ "input"}

    Measure â‡ { ğ•ŠâŸ¨lenâŸ©: lenâ‡
      TimeParams â‡ { âŸ¨/, lenâ†‘Â·/â¼(âŒŠ0.5+ğ•©Ã—len) â€¢rand.Subset lenË™âŸ© }
      timeInit â‡ (len<1e3)âŠ‘âŸ¨0â€¿0.8,1â€¿2â€¿0â€¿4â€¿6â€¿9â€¿3â€¿7â€¿8â€¿5Ã·10âŸ©
    }
  }
  {
    ext â‡ "avg"
    plotname â‡ "Indices from uniform random list"

    params â‡ âŸ¨sizesâŸ©
    input â‡ {
      name â‡ "Average (+Â´Ã·â‰ )"
      max â‡ 100
      range â‡ scale.E13 max
    }
    output â‡ {denom â‡ "output"}

    Measure â‡ { ğ•ŠâŸ¨lâŸ©: Lenâ‡lâŠ¸Ã—
      TimeParams â‡ { âŸ¨/, l â€¢rand.Range (1+2Ã—ğ•©)Ë™âŸ© }
      timeInit â‡ (l<1e3)âŠ‘âŸ¨2â€¿31,4â€¿37â€¿1â€¿6â€¿3â€¿11â€¿2âŸ©
    }
  }

  Inverse "rand"  â€¿"Index list to counts (/â¼)"       â€¿{ğ•©.Rand}
  Inverse "sorted"â€¿"Sorted indices to counts with /â¼"â€¿{ğ•©.RandSort}
  {
    ext â‡ "inverse-runs"
    len â† 10â‹†expâ†4
    plotname â‡ "1e"âˆ¾(â€¢Repr exp)âˆ¾" indices to counts with /â¼"
    params â‡ âŸ¨maxesâŸ©
    input â‡ {
      name â‡ "Average run length"
      range â‡ (âŒŠ0.5âŠ¸+)âŒ¾(lenâŠ¸Ã·) 1.3 scale._exp2d max â‡ len
    }
    output â‡ {denom â‡ "input"}
    Measure â‡ { ğ•Š âŸ¨maxâŸ©: lenâ‡len
      âŸ¨Rand, PartitionâŸ© â† âŸ¨maxâŸ© â€¢Import "../measure/gen.bqn"
      TimeParams â‡ {
        r â† âŒŠ0.5+lenÃ·ğ•© â‹„ m1 â† max-1  # Number of runs, max value
        # Always include m1; avoid ever repeating a value
        RunVals â† max | (1 Rand rË™) (âŠ¢+m1-âŠ‘) 0 âˆ¾ Â·+` 1 + (r-1) Rand m1Ë™
        âŸ¨/â¼, (r Partition lenË™) / RunValsâŸ©
      }
    }
  }
  {
    ext â‡ "inverse-slope"
    len â† 10â‹†expâ†4
    plotname â‡ "Sorted indices to counts with /â¼"
    params â‡ âŸ¨{nameâ€¿rangeâ€¿labelsâ‡ğ•© â‹„ Orderâ‡âŒ½} GetSizes 3â€¿4â€¿5â€¿6âŸ©
    input â‡ {
      name â‡ "Range / length"
      range â‡ 2 Ã— â†•âŠ¸âˆ¾âŠ¸Ã· 15
      log â‡ 0 â‹„ FilterMin â‡ 0âŠ¸<
    }
    output â‡ {denom â‡ "input"}
    Measure â‡ { ğ•Š âŸ¨lenâŸ©: lenâ‡
      âŸ¨RandSortâŸ© â† âŸ¨lenâŸ© â€¢Import "../measure/gen.bqn"
      TimeParams â‡ { âŸ¨/â¼, len RandSort (1âŒˆâŒŠ0.5+ğ•©Ã—len)Ë™âŸ© }
      timeInit â‡ (len<1e3)âŠ‘âŸ¨0.2â€¿1,1â€¿4â€¿10â€¿5â€¿0â€¿6â€¿8â€¿2Ã·10âŸ©
    }
  }
âŸ©
