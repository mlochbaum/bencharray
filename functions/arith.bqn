# Arithmetic functions

basename ← "arith"

ns_v   ← •Import "../params/ns_v.bqn"
types  ← •Import "../params/cputype.bqn"
GetFns ← ⋈ •Import "../params/arith.bqn"˙
GetInp ← {name⇐"Length" ⋄ range⇐𝕩}

Measure ← { 𝕊 type‿fn:
  ⟨float,size,max,GetGen⇐GetGenSmall⟩ ← type ⋄ size⇐
  TimeParams ⇐ {
    # Use one generator for both arguments
    float ∨ ×˙⊸≠fn ? l ← 1‿2/⟨fn, GetGen𝕩⟩ ;
    # In integer × arguments need to interact to suppress overflow: use
    # two parallel generators but run each twice so each argument sees
    # both sets of random numbers
    ⟨fn⟩ ∾ ⊣‿{(××(⌊max÷|𝕨)⌊|)𝕩} {𝕎○𝕏˜}⟜GetGen¨ <𝕩
  }
}

Bench ← {
  ext‿fns‿range‿plotpre‿plotname ← 𝕩
  name ⇐ basename∾ext
  params ⇐ types ⋈ fnobjs ← GetFns fns
  input ⇐ GetInp range
  result ⇐ ns_v
  Measure ⇐ Measure
  PlotPre⇐
  plotOpts ⇐ {
    title ⇐ plotname
    x ⇐ types
    y ⇐ result
    labels ⇐ {𝕩.Disp¨ 𝕩.range} fnobjs
  }
}

Bench¨ ⟨
  {
    ext ⇐ ""
    fns ⇐ ×‿+‿-‿⌊‿⌈
    Range ⇐ {<(2⋆3+15)÷𝕩.size}
    PlotPre ⇐ {> types.num⊸⋈¨ <˘⍉1⊑⎉1𝕩}
    plotname ⇐ "Arithmetic with no overflow, 32KB"
  }
⟩
