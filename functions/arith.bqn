# Dyadic arithmetic functions

basename â† "arith"

ns_v   â† â€¢Import "../params/ns_v.bqn"
scales â† â€¢Import "../measure/scale.bqn"
typesâ€¿itypes â† â€¢ImportâŸœ"../params/cputype.bqn"Â¨ âŸ¨âŸ©â€¿âŸ¨"Input type"âŸ©
typeb  â† â€¢Import "../params/numtype.bqn"
GetFns â† â‹ˆ â€¢Import "../params/arith.bqn"Ë™
GetInp â† {nameâ‡"Length" â‹„ rangeâ‡ğ•©}

# Measurement functions
MSmall â† { ğ•Š typeâ€¿fn:
  âŸ¨float,size,max,GetGenâ‡GetGenSmallâŸ© â† type â‹„ sizeâ‡
  TimeParams â‡ {
    # Use one generator for both arguments
    float âˆ¨ Ã—Ë™âŠ¸â‰ fn ? l â† 1â€¿2/âŸ¨fn, GetGenğ•©âŸ© ;
    # In integer Ã— arguments need to interact to suppress overflow: use
    # two parallel generators but run each twice so each argument sees
    # both sets of random numbers
    âŸ¨fnâŸ© âˆ¾ âŠ£â€¿{â€¢internal.Squeeze(Ã—Ã—(âŒŠmaxÃ·|ğ•¨)âŒŠ|)ğ•©} {ğ•â—‹ğ•Ëœ}âŸœGetGenÂ¨ <ğ•©
  }
}
_mGen â† { GenPair _ğ•£ typeâ€¿fn:
  âŸ¨size,GetGenâŸ© â† type â‹„ sizeâ‡
  TimeParams â‡ { âŸ¨fnâŸ©âˆ¾getGen GenPair ğ•© }
}
MLarge â† (â‹ˆËœ{ğ•ğ•©})_mGen
MLScal â† {âŸ¨{âŠ‘ğ•}ğ•1,ğ•ğ•©âŸ©}_mGen

Bench â† {
  Measureâ€¿PlotPre â‡ extâ€¿fnsâ€¿rangeâ€¿plotnameâ€¿itype â† ğ•©
  name â‡ basenameâˆ¾ext
  params â‡ âŸ¨types, GetFns fnsâŸ©
  input â‡ GetInp range
  result â‡ ns_v
  plotOpts â‡ {
    title â‡ plotname
    x â‡ itype âŠ‘ typesâ€¿itypes
    y â‡ result
    key â‡ 1âŠ‘params
  }
}
Summary â† Benchâˆ˜{
  extâ‡ğ•¨ â‹„ fnsâ€¿measureâ€¿itypeâ€¿plotname â‡ ğ•©
  Range â‡ {<(2â‹†3+15)Ã·ğ•©.size}
  PlotPre â‡ {> types.numâŠ¸â‹ˆÂ¨ <Ë˜â‰1âŠ‘â‰1ğ•©}
}

Bench2d_sub â† { ğ•Š extâ€¿descâ€¿fnâ€¿isaddâ€¿overâ€¿totalâ€¿axes:
  plotname â‡ descâˆ¾" on list and table"
  name     â‡ basenameâˆ¾ext
  params â‡ âŸ¨(over<isadd)âŠ‘typebâ€¿typesâŸ©
  input â‡ {
    name â‡ "Width"
    range â‡ scales.E2d11 total
  }
  result â‡ ns_v
  Measure â‡ { ğ•Š âŸ¨typeâŸ©:
    getGen â† {âŸ¨Gâ‡GetGenSmallâŸ©: Â¬over? G ; ğ•©.GetGen} type
    Flip â† totalâŒˆâˆ˜Ã·âŠ¢  # Length of other dimension
    Len â‡ FlipâŠ¸Ã—
    TimeParams â‡ { âŸ¨fnâŸ© âˆ¾ GetGenÂ¨ axesâ†‘Â¨<ğ•© }âˆ˜(FlipâŠ¸â‹ˆ)
  }
  plotOpts â‡ {
    title â‡ plotname
    x â‡ input
    y â‡ result
    key â‡ âŠ‘params
  }
}
Lead â† { ext1 ğ•Š fnâ€¿fnameâ€¿overâ€¿total:
  fnâ€¿overâ€¿totalâ‡ â‹„ isaddâ‡{+}â‰¡fn
  desc â‡ "Leading-axis "âˆ¾fname
  ext  â‡ "-lead"âˆ¾ext1
  axes â‡ 1â€¿2
}
Rank1 â† { ext1 ğ•Š fn0â€¿fnameâ€¿overâ€¿total:
  overâ€¿totalâ‡
  Fn â‡ Fn0â‰1 â‹„ isaddâ‡{+}â‰¡fn0
  desc â‡ "Arithmetic "âˆ¾(âˆ§`' 'âŠ¸â‰ )âŠ¸(/âˆ¾"â‰1"âˆ¾Â¬âŠ¸/)fname
  ext  â‡ "-rank"âˆ¾ext1
  axes â‡ Â¯1â€¿2
}
Bench2d â† Lead â‹ˆâ—‹Bench2d_sub Rank1

âˆ¾âŸ¨
  "-summary" Summary âŸ¨Ã—â€¿+â€¿âŒŠâ€¿<,      MSmall, 0, "Arithmetic with no overflow, 32KB"âŸ©
  "-small"   Summary âŸ¨Ã—â€¿+â€¿-â€¿âŒŠâ€¿âŒˆ,    MSmall, 0, "Arithmetic with no overflow, 32KB"âŸ©
  "-over"    Summary âŸ¨Ã—â€¿+â€¿-,        MLarge, 1, "Arithmetic with overflow, 32KB"âŸ©
  "-scal"    Summary âŸ¨Ã—â€¿+â€¿âŒŠâ€¿<,      MLScal, 1, "Scalar-list arithmetic allowing overflow, 32KB"âŸ©
  "-compare" Summary âŸ¨<â€¿>â€¿=â€¿â‰ â€¿â‰¤â€¿â‰¥,  MLarge, 0, "Comparisons, 32KB"âŸ©
  "-slow"    Summary âŸ¨(â‹†â¼)â€¿â‹†â€¿âˆšâ€¿|â€¿Ã·, MLarge, 1, "Slow arithmetic, 32KB"âŸ©
  "-min"     Bench2d âŸ¨âŒŠ, "âŒŠ",0, 1e4âŸ©
  "-less"    Bench2d âŸ¨<, "<",0, 1e4âŸ©
  "-plus"    Bench2d âŸ¨+, "+",0, 1e4âŸ©
  "-plus-over" Bench2d âŸ¨+, "+ (overflow)",1, 1e4âŸ©
âŸ©
